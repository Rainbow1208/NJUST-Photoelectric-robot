#include "Euler_angles.h"
#include "math.h"
#define kp 10.0f		//???????????????
#define ki	0.008f		//????????????????
#define halfT 0.001f	//?????

float q0 = 1,q1 = 0,q2 = 0,q3 = 0;		//???????????,??????
float exInt = 0, eyInt = 0,ezInt = 0;	//??????,?????
/*------?????-----*/
/*
*	ax,ay,az??XYZ??????
*	gx,gy,gz??XYZ??????
*/
void IMUupdate(float gx, float gy, float gz, float ax, float ay, float az)
{
	float norm;				//?????
	
	float vx,vy,vz;
	float ex,ey,ez;
	
/*---?????,??????- ????????????????,?????????????,?????????---*/
	float q0q0 = q0 * q0;
	float q0q1 = q0 * q1;
	float q0q2 = q0 * q2;
	
	float q1q1 = q1 * q1;
	float q1q3 = q1 * q3;
	
	float q2q2 = q2 * q2;
	float q2q3 = q2 * q3;
	
	float q3q3 = q3 * q3;
	
	if(ax*ay*az == 0)
			return;
	
	norm = sqrt((ax * ax) + (ay * ay) + (az *az));		//????????
/*----?? ???????-----*/
	ax = ax / norm;			 
	ay = ay / norm;
	az = az / norm;
	
/*-----?????????/??----*/
	vx = 2*(q1q3 - q0q2);		////????xyz???			
	vy = 2*(q0q1 + q2q3);
	vz = q0q0 - q1q1 - q2q2 + q3q3 ;

	ex = (ay*vz - az*vy) ;            //???????????????
	ey = (az*vx - ax*vz) ;
	ez = (ax*vy - ay*vx) ;	

/*----???????-----*/
	exInt = exInt + ex * ki;								
	eyInt = eyInt + ey * ki;
	ezInt = ezInt + ez * ki;
	
/*-----???????-------*/
	gx = gx + kp*ex + exInt;		   		//???PI???????,???????
	gy = gy + kp*ey + eyInt;
	gz = gz + kp*ez + ezInt;				//???gz????????????????,??????????????
		
/*------????????------*/
	q0 = q0 + (-q1*gx - q2*gy - q3*gz)*halfT;
	q1 = q1 + (q0*gx + q2*gz - q3*gy)*halfT;
	q2 = q2 + (q0*gy - q1*gz + q3*gx)*halfT;
	q3 = q3 + (q0*gz + q1*gy - q2*gx)*halfT;


/*----??????----*/	
	norm = sqrt(q0*q0 + q1*q1 + q2*q2 + q3*q3);
/*----???????------*/
	q0 = q0 / norm;
	q1 = q1 / norm;
	q2 = q2 / norm;
	q3 = q3 / norm;
	
/*-------?????-------*/
	Euler_Angle.Z = GYRO_I.Z;
	Euler_Angle.X = asin( (-2 * q1 * q3) + (2 * q0 * q2)) * RTA;
	Euler_Angle.Y = atan2( ((2 * q2 * q3) + (2 * q0 * q1)) , ((-2 * q1 * q1) - (2 * q2 * q2) + 1)) * RTA;

}
